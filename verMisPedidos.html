<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis pedidos</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Iconos de Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body class="bg-light">

  <!-- HEADER -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <!-- Logo -->
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png" width="50" height="45" class="me-2">
        <h2 class="mb-0">PolloAsado</h2>
      </a>

      <div class="d-flex align-items-center">
        <a href="promociones.html" class="nav-link text-white me-4 fw-semibold">
          <i class="bi bi-megaphone-fill me-1"></i> Promociones
        </a>
        <a href="registroUsuario.html" class="nav-link text-white me-3">
          <i class="bi bi-person-circle" style="font-size:1.5rem;"></i>
        </a>
        <a href="Pedidos.html" class="nav-link text-white position-relative">
          <i class="bi bi-cart3" style="font-size:1.5rem;"></i>
        </a>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="container mt-4">
    <h2 class="text-center mb-4"> Mis pedidos</h2>

    <div class="row">
      <!-- LISTA DE PEDIDOS -->
      <div class="col-md-8">
        <div class="card">
          <div class="card-header text-center bg-primary text-white">
            <h5>Historial de pedidos</h5>
          </div>
          <div class="card-body" id="contenedorPedidos">
            <p class="text-center text-muted">Cargando tus pedidos...</p>
          </div>
        </div>
      </div>

      <!-- COLUMNA DERECHA: DETALLE DEL PEDIDO -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header text-center">
            <h5>Detalle del pedido</h5>
          </div>
          <div class="card-body">
            <p id="detalle-info" class="text-muted">
              Selecciona un pedido para ver sus productos.
            </p>

            <ul id="detalle-items" class="list-group mb-3"></ul>

            <p class="text-end">
              <strong>Total:</strong> <span id="detalle-total">$0</span>
            </p>

            <a id="btnSeguimiento" href="#" class="btn btn-primary w-100 disabled">
              Ver seguimiento del pedido
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="bg-black text-white mt-5">
    <div class="container py-4">
      <div class="row">
        <div class="col-md-3 mb-3">
          <h4>PolloFast</h4>
          <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png" alt="logo" width="50" height="45" class="me-2">
        </div>
        <div class="col-md-3 mb-3">
          <h6>Conócenos</h6>
          <p class="mb-1">Teléfono</p>
          <p class="mb-1">Mail de contacto</p>
          <p class="mb-1">Términos y condiciones</p>
          <p class="mb-0">Política de privacidad</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Redes sociales</h6>
          <p class="mb-1"><i class="bi bi-instagram"></i> Instagram</p>
          <p class="mb-1"><i class="bi bi-facebook"></i> Facebook</p>
          <p class="mb-0"><i class="bi bi-twitter-x"></i> X</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Mi cuenta</h6>
          <p class="mb-1">Pedir</p>
          <p class="mb-0">Iniciar sesión</p>
        </div>
      </div>
      <div class="text-center mt-3">
        <small><i class="bi bi-circle"></i></small>
      </div>
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Protección de rutas (mismo que usas en puntos) -->
  <script src="js/protegerRutas.js"></script>

  <script>
    const API_BASE = "http://127.0.0.1:8000/api/pollosabroso";
    const token = requireAuth();  // asegura sesión

    const contenedor = document.getElementById("contenedorPedidos");
    const detalleInfo = document.getElementById("detalle-info");
    const detalleItems = document.getElementById("detalle-items");
    const detalleTotal = document.getElementById("detalle-total");
    const btnSeguimiento = document.getElementById("btnSeguimiento");

    function formatearCLP(monto) {
      return new Intl.NumberFormat("es-CL", {
        style: "currency",
        currency: "CLP",
        minimumFractionDigits: 0
      }).format(monto);
    }

    async function cargarPedidos() {
      try {
        const res = await fetch(`${API_BASE}/clientes/me/mis-pedidos`, {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        if (!res.ok) {
          console.error("Error al obtener pedidos");
          contenedor.innerHTML = `
            <p class="text-center text-muted">Error al cargar tus pedidos.</p>
          `;
          return;
        }

        const pedidos = await res.json();
        console.log("[mis pedidos]", pedidos);

        if (!pedidos.length) {
          contenedor.innerHTML = `
            <p class="text-center text-muted">Aún no has realizado pedidos.</p>
          `;
          return;
        }

        contenedor.innerHTML = "";

        pedidos.forEach(p => {
          const card = document.createElement("div");
          card.className = "card mb-3 shadow-sm pedido-card";
          card.style.cursor = "pointer";

          const fecha = new Date(p.date).toLocaleString("es-CL");

          const badgeClass =
            p.status === "Entregado" ? "bg-success" :
            p.status === "En ruta" ? "bg-info" :
            "bg-warning text-dark";

          card.innerHTML = `
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">${p.description}</h6>
                <small class="text-muted">${fecha}</small>
              </div>
              <div class="text-end">
                <div class="fw-bold">${formatearCLP(p.total)}</div>
                <span class="badge ${badgeClass}">${p.status}</span>
              </div>
            </div>
          `;

          card.addEventListener("click", () => mostrarDetalle(p));
          contenedor.appendChild(card);
        });

      } catch (err) {
        console.error("Error de conexión al cargar pedidos", err);
        contenedor.innerHTML = `
          <p class="text-center text-muted">Error de conexión al cargar tus pedidos.</p>
        `;
      }
    }

    function mostrarDetalle(pedido) {
      const fecha = new Date(pedido.date).toLocaleString("es-CL");
      detalleInfo.textContent = `Pedido del ${fecha} – Estado: ${pedido.status}`;
      detalleItems.innerHTML = "";

      let totalCalculado = 0;

      pedido.items.forEach(item => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";

        const subtotal = (item.price || 0) * item.quantity;
        totalCalculado += subtotal;

        li.innerHTML = `
          <span>${item.productName} (x${item.quantity})</span>
          <span>${formatearCLP(subtotal)}</span>
        `;
        detalleItems.appendChild(li);
      });

      const totalMostrar = pedido.total || totalCalculado;
      detalleTotal.textContent = formatearCLP(totalMostrar);

      // Activar botón de seguimiento
      btnSeguimiento.href = `seguimientoPedido.html?orderId=${pedido.id}`;
      btnSeguimiento.classList.remove("disabled");
    }

    document.addEventListener("DOMContentLoaded", cargarPedidos);
  </script>
</body>
</html>
