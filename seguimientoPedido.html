<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento de Pedido - PolloAsado</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    body { background:#f8f9fa; }
    .estado { font-weight:600; }
    .progress-step { display:flex; flex-direction:column; align-items:center; }
    .progress-step i { font-size:2rem; margin-bottom:6px; }
    .progress-step.active i { color:#0d6efd; }
    .progress-step.completed i { color:#198754; }
    .eta-box {
      background:#fff;
      border:1px solid #ddd;
      border-radius:8px;
      padding:15px;
      text-align:center;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
    }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png" width="45" height="40" class="me-2">
        <h2 class="mb-0">PolloAsado</h2>
      </a>
      <div class="d-flex">
        <a href="registroUsuario.html" class="nav-link text-white me-3">
          <i class="bi bi-person-circle" style="font-size:1.5rem;"></i>
        </a>
        <a href="Pedidos.html" class="nav-link text-white">
          <i class="bi bi-cart3" style="font-size:1.5rem;"></i>
        </a>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <div class="container my-5">
    <h3 class="text-center mb-4"> Seguimiento de tu Pedido</h3>
    <p class="text-center text-muted mb-4">Observa en tiempo real el avance de tu orden.</p>

    <!-- Informaci贸n general -->
    <div class="eta-box mb-3">
      <h5 class="mb-1">Pedido #<span id="pedido-id">-</span></h5>
      <p class="mb-2 text-muted">
        Estado actual:
        <span id="estado-actual" class="estado text-primary">Cargando...</span>
      </p>
      <p class="mb-0">
        <i class="bi bi-clock me-2"></i>
        Tiempo estimado de llegada: <span id="eta-min">20</span> min
      </p>
    </div>

    <!-- Info del repartidor -->
    <div id="driver-card" class="eta-box mb-4 d-none">
      <h6 class="mb-1">Repartidor asignado</h6>
      <p class="mb-1">
        <i class="bi bi-person-badge me-2"></i>
        <span id="driver-name">-</span>
      </p>
      <p class="mb-0">
        <i class="bi bi-telephone me-2"></i>
        <span id="driver-phone">-</span>
      </p>
    </div>

    <!-- Progreso visual -->
    <div class="container">
      <div class="row text-center">
        <div class="col progress-step" id="step-prep">
          <i class="bi bi-egg-fried"></i>
          <span>En preparaci贸n</span>
        </div>
        <div class="col progress-step" id="step-camino">
          <i class="bi bi-truck"></i>
          <span>En camino</span>
        </div>
        <div class="col progress-step" id="step-entregado">
          <i class="bi bi-house-check"></i>
          <span>Entregado</span>
        </div>
      </div>
      <div class="progress mt-4" style="height:10px;">
        <div id="barra-progreso"
             class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
             style="width:33%">
        </div>
      </div>
    </div>

    <!-- Mapa simulado -->
    <div class="text-center mt-5">
      <div class="mapa-placeholder mx-auto"
           style="height:250px; width:100%; max-width:600px;
                  background:linear-gradient(90deg,#e9ecef,#f8f9fa);
                  border-radius:10px; display:flex;
                  align-items:center; justify-content:center;
                  color:#6c757d;">
        <i class="bi bi-map"></i> Mapa de ruta (simulado)
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="bg-black text-white mt-auto">
    <div class="container py-4">
      <div class="row">
        <div class="col-md-3 mb-3">
          <h4>PolloFast</h4>
          <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png" width="50" height="45" class="me-2">
        </div>
        <div class="col-md-3 mb-3">
          <h6>Con贸cenos</h6>
          <p>Tel茅fono</p>
          <p>Mail de contacto</p>
          <p>T茅rminos y condiciones</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Redes sociales</h6>
          <p><i class="bi bi-instagram"></i> Instagram</p>
          <p><i class="bi bi-facebook"></i> Facebook</p>
          <p><i class="bi bi-twitter-x"></i> X</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Mi cuenta</h6>
          <p>Pedir</p>
          <p>Iniciar sesi贸n</p>
        </div>
      </div>
      <div class="text-center mt-3">
        <small><i class="bi bi-circle"></i></small>
      </div>
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Protecci贸n de rutas -->
  <script src="js/protegerRutas.js"></script>

  <script>
    const API_BASE = "http://127.0.0.1:8000/api/pollosabroso";
    const token = requireAuth(); // usa el mismo patr贸n que en mis pedidos / puntos

    // Tomar orderId de la URL: ?orderId=XXXX
    const params = new URLSearchParams(window.location.search);
    const orderId = params.get("orderId");

    if (!orderId) {
      alert("Falta el ID del pedido en la URL (ej: seguimientoPedido.html?orderId=...)");
    }

    // Elementos del DOM
    const estadoTexto     = document.getElementById("estado-actual");
    const etaSpan         = document.getElementById("eta-min");
    const barra           = document.getElementById("barra-progreso");
    const driverCard      = document.getElementById("driver-card");
    const driverNameSpan  = document.getElementById("driver-name");
    const driverPhoneSpan = document.getElementById("driver-phone");
    const pedidoIdSpan    = document.getElementById("pedido-id");

    const steps = {
      prep:      document.getElementById("step-prep"),
      camino:    document.getElementById("step-camino"),
      entregado: document.getElementById("step-entregado"),
    };

    // ETA decorativa
    let tiempoRestante   = 20;
    let pollingIntervalId = null;
    let etaIntervalId     = null;

    // Normaliza el texto del backend a uno de los 3 estados
    function normalizarEstado(status) {
      const s = (status || "").toLowerCase();

      if (s.includes("prep"))   return "En preparaci贸n"; // "En preparaci贸n"
      if (s.includes("ruta") || s.includes("camino")) return "En camino"; // "En ruta", "En camino"
      if (s.includes("entreg")) return "Entregado"; // "Entregado"

      return "En preparaci贸n";
    }

    // Aplica el estado a los pasos + barra de progreso
    function aplicarEstadoUI(estadoNormalizado) {
      // reset clases
      Object.values(steps).forEach(step => {
        step.classList.remove("active", "completed");
      });

      if (estadoNormalizado === "En preparaci贸n") {
        estadoTexto.textContent = "En preparaci贸n";
        barra.style.width = "33%";
        steps.prep.classList.add("active");
      } else if (estadoNormalizado === "En camino") {
        estadoTexto.textContent = "En camino";
        barra.style.width = "66%";
        steps.prep.classList.add("completed");
        steps.camino.classList.add("active");
      } else {
        estadoTexto.textContent = "Entregado";
        barra.style.width = "100%";
        steps.prep.classList.add("completed");
        steps.camino.classList.add("completed");
        steps.entregado.classList.add("active");
      }
    }

    function disminuirETA() {
      if (tiempoRestante > 0) {
        tiempoRestante--;
        etaSpan.textContent = tiempoRestante;
      }
    }

    // Llamar al backend para obtener el tracking real
    async function cargarTracking() {
      if (!orderId) return;

      try {
        const res = await fetch(`${API_BASE}/tracking/${orderId}`, {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        if (!res.ok) {
          console.error("Error obteniendo tracking:", await res.text());
          return;
        }

        const data = await res.json();
        console.log("[tracking] data:", data);

        // Mostrar ID del pedido (recortado)
        if (pedidoIdSpan) {
          pedidoIdSpan.textContent = data.orderId
            ? data.orderId.slice(0, 8) + "..."
            : "-";
        }

        // 1) Actualizar estado visual
        const estadoNormalizado = normalizarEstado(data.status);
        aplicarEstadoUI(estadoNormalizado);

        // 2) Actualizar info del repartidor
        if (data.driver) {
          driverCard.classList.remove("d-none");
          driverNameSpan.textContent  = data.driver.name  || "Repartidor asignado";
          driverPhoneSpan.textContent = data.driver.phone || "Tel茅fono no disponible";
        } else {
          driverCard.classList.add("d-none");
        }

        // 3) Si est谩 entregado, ponemos ETA 0 y dejamos de descontar / hacer polling
        if (estadoNormalizado === "Entregado") {
          tiempoRestante = 0;
          etaSpan.textContent = "0";
          if (etaIntervalId) clearInterval(etaIntervalId);
          if (pollingIntervalId) clearInterval(pollingIntervalId);
        }

      } catch (err) {
        console.error("Error en tracking:", err);
      }
    }

    // Inicializaci贸n
    window.addEventListener("DOMContentLoaded", () => {
      if (!orderId) return;

      // Estado inicial
      aplicarEstadoUI("En preparaci贸n");

      // ETA inicial
      etaSpan.textContent = tiempoRestante;
      etaIntervalId = setInterval(disminuirETA, 60000); // cada minuto

      // Primer fetch inmediato
      cargarTracking();

      // Polling cada 10 segundos
      pollingIntervalId = setInterval(cargarTracking, 10000);
    });
  </script>

</body>
</html>
