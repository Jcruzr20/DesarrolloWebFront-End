<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canjear puntos - PolloAsado</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    body {
      background-color: #f8f9fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    footer {
      background: #000;
      color: #fff;
      padding: 40px 0;
      margin-top: auto;
    }
    footer h4 { color: #ffc107; font-weight: bold; }
    footer h6 { font-weight: 600; margin-bottom: 10px; }
    footer p  { margin-bottom: 6px; font-size: 0.95em; }
    footer small { color: #aaa; }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png"
             width="50" height="45" class="me-2">
        <h2 class="mb-0">PolloAsado</h2>
      </a>
      <div class="d-flex align-items-center">
        <a href="promociones.html" class="nav-link text-white me-4 fw-semibold">
          <i class="bi bi-megaphone-fill me-1"></i> Promociones
        </a>
        <a href="registroUsuario.html" class="nav-link text-white me-3">
          <i class="bi bi-person-circle" style="font-size:1.5rem;"></i>
        </a>
        <a href="Pedidos.html" class="nav-link text-white position-relative">
          <i class="bi bi-cart3" style="font-size:1.5rem;"></i>
        </a>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <div class="container mt-4 mb-5 flex-grow-1">
    <h2 class="text-center mb-3"> Canje de puntos</h2>
    <p class="text-center text-muted mb-4">
      Por cada <strong>300 puntos</strong> puedes generar un <strong>cup贸n de 15% de descuento</strong>
      para usar en tus compras.
    </p>

    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h4 class="card-title mb-3">Mi saldo</h4>

            <p class="mb-1">
              <strong>Puntos disponibles:</strong>
              <span id="lblPuntos" class="fw-bold">-</span>
            </p>
            <p class="mb-3 text-muted">
              Regla: 300 puntos = cup贸n de 15% de descuento.
            </p>

            <hr>

            <h5 class="mb-3">Generar cup贸n</h5>

            <div class="mb-3">
              <button class="btn btn-primary w-100" id="btnCanjear">
                <i class="bi bi-gift-fill me-1"></i>
                Canjear 300 puntos por cup贸n 15%
              </button>
            </div>

            <div id="mensajeResultado" class="alert d-none" role="alert"></div>

            <div id="contenedorCupon" class="mt-3 d-none">
              <h6>Cup贸n generado:</h6>
              <p class="mb-1">
                <strong>C贸digo:</strong>
                <span id="lblCodigoCupon" class="fw-bold"></span>
              </p>
              <p class="mb-0">
                <strong>Descuento:</strong> <span id="lblDescuento">15%</span>
              </p>
            </div>

            <p class="text-muted mt-3 mb-0">
              *Este cup贸n lo puedes usar en el flujo de compra donde se pidan c贸digos
              de descuento (Diagrama 22).
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER igual al resto -->
  <footer>
    <div class="container">
      <div class="row text-center text-md-start">
        <div class="col-md-3 mb-3">
          <h4>PolloFast</h4>
          <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png"
               width="50" height="45">
        </div>
        <div class="col-md-3 mb-3">
          <h6>Con贸cenos</h6>
          <p>Tel茅fono</p>
          <p>Mail de contacto</p>
          <p>T茅rminos y condiciones</p>
          <p>Pol铆tica de privacidad</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Redes sociales</h6>
          <p><i class="bi bi-instagram"></i> Instagram</p>
          <p><i class="bi bi-facebook"></i> Facebook</p>
          <p><i class="bi bi-twitter-x"></i> X</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Mi cuenta</h6>
          <p>Pedir</p>
          <p>Iniciar sesi贸n</p>
        </div>
      </div>
      <div class="text-center mt-3">
        <small><i class="bi bi-circle"></i></small>
      </div>
    </div>
  </footer>

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Protecci贸n de rutas -->
  <script src="js/protegerRutas.js"></script>

  <!-- L贸gica de puntos -->
  <script>
    const API = "http://127.0.0.1:8000/api/pollosabroso";

    const lblPuntos        = document.getElementById("lblPuntos");
    const btnCanjear       = document.getElementById("btnCanjear");
    const mensajeResultado = document.getElementById("mensajeResultado");
    const contenedorCupon  = document.getElementById("contenedorCupon");
    const lblCodigoCupon   = document.getElementById("lblCodigoCupon");
    const lblDescuento     = document.getElementById("lblDescuento");

    const token = requireAuth(); // obtiene el JWT del cliente logueado

    async function cargarPuntos() {
      try {
        const res = await fetch(`${API}/clientes/me`, {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        if (!res.ok) {
          console.error("[puntos] Error HTTP:", await res.text());
          lblPuntos.textContent = "-";
          return;
        }

        const data = await res.json();
        console.log("[puntos] perfil:", data);

        lblPuntos.textContent = data.points ?? 0;
      } catch (err) {
        console.error("[puntos] Error de conexi贸n:", err);
      }
    }

    async function canjearPuntos() {
      try {
        const res = await fetch(`${API}/clientes/me/puntos/canjear`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          // Enviamos amount pero el backend lo ignora (regla fija 300 puntos)
          body: JSON.stringify({ amount: 300 })
        });

        const data = await res.json();
        console.log("[puntos] canje:", data);

        if (!res.ok) {
          mensajeResultado.className = "alert alert-danger";
          mensajeResultado.textContent = data.detail || "Error al canjear puntos.";
          mensajeResultado.classList.remove("d-none");
          contenedorCupon.classList.add("d-none");
          return;
        }

        mensajeResultado.className = "alert alert-success";
        mensajeResultado.textContent = data.message;
        mensajeResultado.classList.remove("d-none");

        // actualizar saldo mostrado
        lblPuntos.textContent = data.points ?? 0;

        // mostrar cup贸n generado
        if (data.couponCode) {
          lblCodigoCupon.textContent = data.couponCode;
          lblDescuento.textContent = (data.discountPct || 15) + "%";
          contenedorCupon.classList.remove("d-none");
        } else {
          contenedorCupon.classList.add("d-none");
        }

      } catch (err) {
        console.error("[puntos] Error de conexi贸n al canjear:", err);
        mensajeResultado.className = "alert alert-danger";
        mensajeResultado.textContent = "Error de conexi贸n al canjear puntos.";
        mensajeResultado.classList.remove("d-none");
        contenedorCupon.classList.add("d-none");
      }
    }

    btnCanjear.addEventListener("click", canjearPuntos);

    // cargar puntos al entrar
    cargarPuntos();
  </script>
</body>
</html>
