<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alertas de tiempo de cocina - PolloAsado</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  >

  <style>
    body {
      background-color: #f8f9fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    footer {
      background: #000;
      color: #fff;
      padding: 40px 0;
      margin-top: auto;
    }
    footer h4 { color: #ffc107; font-weight: bold; }
    footer h6 { font-weight: 600; margin-bottom: 10px; }
    footer p  { margin-bottom: 6px; font-size: 0.95em; }
    footer small { color: #aaa; }

    .alert-card {
      border-left: 5px solid #dc3545;
    }
    .badge-estado {
      min-width: 120px;
    }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png"
             width="50" height="45" class="me-2">
        <h2 class="mb-0">PolloAsado</h2>
      </a>
      <div class="d-flex align-items-center">
        <a href="promociones.html" class="nav-link text-white me-4 fw-semibold">
          <i class="bi bi-megaphone-fill me-1"></i> Promociones
        </a>
        <a href="registroUsuario.html" class="nav-link text-white me-3">
          <i class="bi bi-person-circle" style="font-size:1.5rem;"></i>
        </a>
        <a href="Pedidos.html" class="nav-link text-white position-relative">
          <i class="bi bi-cart3" style="font-size:1.5rem;"></i>
        </a>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <div class="container mt-4 mb-5 flex-grow-1">
    <h2 class="text-center mb-3">‚è± Alertas de tiempo en cocina</h2>
    <p class="text-center text-muted mb-4">
      Aqu√≠ ver√°s los pedidos que llevan demasiado tiempo en <strong>En cocina</strong> o
      <strong>En preparaci√≥n</strong>, seg√∫n el l√≠mite configurado.
    </p>

    <!-- Controles -->
    <div class="row mb-4 align-items-center">
      <div class="col-md-6 mb-2">
        <label for="inputLimite" class="form-label fw-semibold">
          L√≠mite de minutos para generar alerta:
        </label>
        <div class="input-group">
          <input
            type="number"
            id="inputLimite"
            class="form-control"
            min="5"
            step="5"
          >
          <span class="input-group-text">min</span>
          <button class="btn btn-outline-primary" id="btnGuardarLimite">
            Guardar
          </button>
        </div>
        <small class="text-muted">
          Se guarda en el navegador como configuraci√≥n personal.
        </small>
      </div>

      <div class="col-md-6 mb-2 text-md-end text-center">
        <!-- NUEVO: bot√≥n para volver al panel -->
        <a href="panelControl.html" class="btn btn-outline-dark me-2">
          <i class="bi bi-arrow-left-circle me-1"></i> Volver a panel
        </a>

        <!-- Bot√≥n refrescar -->
        <button class="btn btn-outline-secondary me-2" id="btnRefrescar">
          <i class="bi bi-arrow-clockwise me-1"></i> Refrescar ahora
        </button>

        <!-- NUEVO: filtro de ‚Äúsolo hoy‚Äù -->
        <div class="form-check d-inline-block mt-2">
          <input class="form-check-input" type="checkbox" id="chkSoloHoy">
          <label class="form-check-label text-muted" for="chkSoloHoy">
            Mostrar solo pedidos de hoy
          </label>
        </div>

        <span class="text-muted d-block mt-1">
          Actualizaci√≥n autom√°tica cada 60&nbsp;s
        </span>
      </div>
    </div>

    <!-- Listado de alertas -->
    <div id="contenedorAlertas" class="row g-3">
      <p class="text-center text-muted">Cargando alertas...</p>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="container">
      <div class="row text-center text-md-start">
        <div class="col-md-3 mb-3">
          <h4>PolloFast</h4>
          <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png"
               width="50" height="45">
        </div>
        <div class="col-md-3 mb-3">
          <h6>Con√≥cenos</h6>
          <p>Tel√©fono</p>
          <p>Mail de contacto</p>
          <p>T√©rminos y condiciones</p>
          <p>Pol√≠tica de privacidad</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Redes sociales</h6>
          <p><i class="bi bi-instagram"></i> Instagram</p>
          <p><i class="bi bi-facebook"></i> Facebook</p>
          <p><i class="bi bi-twitter-x"></i> X</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Mi cuenta</h6>
          <p>Pedir</p>
          <p>Iniciar sesi√≥n</p>
        </div>
      </div>
      <div class="text-center mt-3">
        <small><i class="bi bi-circle"></i></small>
      </div>
    </div>
  </footer>

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- L√ìGICA DE ALERTAS -->
  <script>
    const API = "http://127.0.0.1:8000/api/pollosabroso";

    const contenedorAlertas = document.getElementById("contenedorAlertas");
    const inputLimite      = document.getElementById("inputLimite");
    const btnGuardarLimite = document.getElementById("btnGuardarLimite");
    const btnRefrescar     = document.getElementById("btnRefrescar");
    const chkSoloHoy       = document.getElementById("chkSoloHoy");

    const LIMITE_DEFAULT = 20;
    let limiteMinutos =
      parseInt(localStorage.getItem("tiempoMaxCocina")) || LIMITE_DEFAULT;

    // Mostrar el l√≠mite actual
    inputLimite.value = limiteMinutos;

    function minutosDesde(fechaISO) {
      if (!fechaISO) return 0;
      const fecha = new Date(fechaISO);
      const ahora = new Date();
      const diffMs = ahora - fecha;
      return Math.floor(diffMs / 60000); // ms ‚Üí minutos
    }

    function esEstadoDeCocina(status) {
      const s = (status || "").toLowerCase();
      return s.includes("prepar") || s.includes("cocina");
    }

    // NUEVO: verificar si el pedido es del d√≠a de hoy (fecha local)
    function esDeHoy(fechaISO) {
      if (!fechaISO) return false;
      const f   = new Date(fechaISO);
      const hoy = new Date();
      return (
        f.getFullYear() === hoy.getFullYear() &&
        f.getMonth()    === hoy.getMonth() &&
        f.getDate()     === hoy.getDate()
      );
    }

    async function cargarAlertas(token) {
      try {
        contenedorAlertas.innerHTML =
          '<p class="text-center text-muted">Cargando alertas...</p>';

        const res = await fetch(`${API}/cocina/panel-control`, {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        if (!res.ok) {
          contenedorAlertas.innerHTML = `
            <p class="text-center text-muted">
              Error al obtener datos de cocina.
            </p>`;
          console.error("[alertas] Error HTTP:", await res.text());
          return;
        }

        const pedidos = await res.json();
        console.log("[alertas] pedidos panel-control:", pedidos);

        const soloHoy = chkSoloHoy.checked;

        const alertas = pedidos
          .map(p => {
            const mins = minutosDesde(p.createdAt);
            return { ...p, minutos: mins };
          })
          .filter(p => {
            if (soloHoy && !esDeHoy(p.createdAt)) {
              return false;
            }
            return esEstadoDeCocina(p.status) && p.minutos > limiteMinutos;
          })
          .sort((a, b) => b.minutos - a.minutos); // m√°s cr√≠ticos primero

        if (!alertas.length) {
          contenedorAlertas.innerHTML = `
            <p class="text-center text-success">
              ‚úÖ No hay pedidos con retraso seg√∫n el l√≠mite de ${limiteMinutos} minutos
              ${soloHoy ? " para hoy." : "."}
            </p>`;
          return;
        }

        contenedorAlertas.innerHTML = "";

        alertas.forEach(p => {
          contenedorAlertas.innerHTML += `
            <div class="col-md-6">
              <div class="card alert-card shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h5 class="card-title mb-1">
                        Pedido #${p.id.slice(0,8)}...
                      </h5>
                      <p class="mb-1">
                        <strong>Cliente:</strong> ${p.customerName || "Cliente"}
                      </p>
                      <p class="mb-1">
                        <strong>Total:</strong> $${p.total}
                      </p>
                      <p class="mb-1">
                        <strong>Tiempo en cocina:</strong>
                        ${p.minutos} min
                        <span class="text-danger">
                          (+${p.minutos - limiteMinutos} min sobre el l√≠mite)
                        </span>
                      </p>
                      <p class="mb-0">
                        <strong>Creado:</strong>
                        ${new Date(p.createdAt).toLocaleString("es-CL")}
                      </p>
                    </div>
                    <span class="badge bg-danger badge-estado">
                      ${p.status}
                    </span>
                  </div>

                  <hr class="my-2">

                  <p class="fw-bold mb-1">Items:</p>
                  <ul class="mb-0">
                    ${p.items.map(i => `
                      <li>${i.productName} x${i.quantity}</li>
                    `).join("")}
                  </ul>
                </div>
              </div>
            </div>
          `;
        });

      } catch (err) {
        console.error("[alertas] Error de conexi√≥n:", err);
        contenedorAlertas.innerHTML = `
          <p class="text-center text-muted">
            Error de conexi√≥n al cargar alertas.
          </p>`;
      }
    }

    // Guardar nuevo l√≠mite
    btnGuardarLimite.addEventListener("click", () => {
      const nuevo = parseInt(inputLimite.value);
      if (isNaN(nuevo) || nuevo <= 0) {
        alert("Ingresa un n√∫mero de minutos v√°lido.");
        inputLimite.value = limiteMinutos;
        return;
      }
      limiteMinutos = nuevo;
      localStorage.setItem("tiempoMaxCocina", limiteMinutos);
      alert(`L√≠mite actualizado a ${limiteMinutos} minutos ‚úÖ`);
      if (window.token) {
        cargarAlertas(window.token);
      }
    });

    // Bot√≥n refrescar
    btnRefrescar.addEventListener("click", () => {
      if (window.token) {
        cargarAlertas(window.token);
      }
    });

    // Cuando cambie el filtro ‚Äúsolo hoy‚Äù, recargar
    chkSoloHoy.addEventListener("change", () => {
      if (window.token) {
        cargarAlertas(window.token);
      }
    });

    // Intervalo autom√°tico (60s)
    let autoRefreshId = null;
    function iniciarAutoRefresh() {
      if (autoRefreshId) clearInterval(autoRefreshId);
      autoRefreshId = setInterval(() => {
        if (window.token) {
          cargarAlertas(window.token);
        }
      }, 60000);
    }
  </script>

  <!-- Protecci√≥n de rutas -->
  <script src="js/protegerRutas.js"></script>
  <script>
    console.log("[alertas] Obteniendo token...");
    const token = requireAuth();    // üëà se declara UNA sola vez
    window.token = token;          // para usarlo en otros scripts

    // Cargar alertas iniciales y activar refresco autom√°tico
    cargarAlertas(token);
    iniciarAutoRefresh();
  </script>

</body>
</html>
