<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cuenta de Usuario - PolloAsado</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    body {
      background-color: #f8f9fa;
    }
    .card {
      transition: all 0.3s ease;
    }
    .link-toggle {
      cursor: pointer;
      color: #0d6efd;
      text-decoration: underline;
    }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- NAVBAR -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png" width="50" height="45" class="me-2">
        <h2 class="mb-0">PolloAsado</h2>
      </a>

      <div class="d-flex align-items-center">
        <a href="promociones.html" class="nav-link text-white me-4 fw-semibold">
          <i class="bi bi-megaphone-fill me-1"></i> Promociones
        </a>
        <!-- NUEVO: Ver Men√∫ -->
        <a href="Personalizaci√≥n.html" class="nav-link text-white me-4 fw-semibold">
          <i class="bi bi-egg-fried me-1"></i> Ver Men√∫
        </a>
        <!-- Icono usuario con id para manejarlo por JS -->
        <a id="linkUsuario" href="registroUsuario.html" class="nav-link text-white me-3">
          <i class="bi bi-person-circle" style="font-size:1.5rem;"></i>
        </a>
        <a href="Pedidos.html" class="nav-link text-white">
          <i class="bi bi-cart3" style="font-size:1.5rem;"></i>
        </a>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-md-6">

        <!-- Tarjeta -->
        <div class="card shadow-sm">
          <div class="card-header text-center bg-primary text-white">
            <h4 id="form-title">Iniciar Sesi√≥n</h4>
          </div>
          <div class="card-body">

            <!-- Formulario LOGIN -->
            <form id="login-form">
              <div class="mb-3">
                <label for="emailLogin" class="form-label">Correo electr√≥nico</label>
                <input type="email" class="form-control" id="emailLogin" placeholder="Ej: usuario@gmail.com" required>
              </div>
              <div class="mb-3">
                <label for="passwordLogin" class="form-label">Contrase√±a</label>
                <input type="password" class="form-control" id="passwordLogin" placeholder="Tu contrase√±a" required>
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="remember">
                  <label class="form-check-label" for="remember">Recordarme</label>
                </div>
                <a href="reestablecer.html" class="small text-decoration-none text-primary">
                  ¬øOlvidaste tu contrase√±a?
                </a>
              </div>

              <button type="submit" class="btn btn-primary w-100">Ingresar</button>

              <div class="text-center mt-3">
                <small>¬øNo tienes una cuenta? 
                  <span class="link-toggle" id="show-register">Crear nueva cuenta</span>
                </small>
              </div>
            </form>

            <!-- Formulario REGISTRO -->
            <form id="register-form" style="display:none;">
              <div class="mb-3">
                <label for="emailRegister" class="form-label">Correo electr√≥nico</label>
                <input type="email" class="form-control" id="emailRegister" placeholder="Ej: usuario@gmail.com" required>
              </div>
              <div class="mb-3">
                <label for="passwordRegister" class="form-label">Contrase√±a</label>
                <input type="password" class="form-control" id="passwordRegister" placeholder="Crea una contrase√±a" required>
              </div>
              <div class="mb-3">
                <label for="passwordConfirm" class="form-label">Confirmar contrase√±a</label>
                <input type="password" class="form-control" id="passwordConfirm" placeholder="Repite tu contrase√±a" required>
              </div>

              <button type="submit" class="btn btn-success w-100">Crear Cuenta</button>

              <div class="text-center mt-3">
                <small>¬øYa tienes cuenta? 
                  <span class="link-toggle" id="show-login">Volver a iniciar sesi√≥n</span>
                </small>
              </div>
            </form>

            <!-- Mensaje -->
            <div id="mensaje" class="mt-3 text-center fw-semibold"></div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="bg-black text-white mt-auto">
    <div class="container py-4">
      <div class="row">
        <div class="col-md-3 mb-3">
          <h4>PolloFast</h4>
          <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png" width="50" height="45" class="me-2">
        </div>
        <div class="col-md-3 mb-3">
          <h6>Con√≥cenos</h6>
          <p>Tel√©fono</p>
          <p>Mail de contacto</p>
          <p>T√©rminos y condiciones</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Redes sociales</h6>
          <p><i class="bi bi-instagram"></i> Instagram</p>
          <p><i class="bi bi-facebook"></i> Facebook</p>
          <p><i class="bi bi-twitter-x"></i> X</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Mi cuenta</h6>
          <p>Pedir</p>
          <p>Iniciar sesi√≥n</p>
        </div>
      </div>
      <div class="text-center mt-3">
        <small><i class="bi bi-circle"></i></small>
      </div>
    </div>
  </footer>


  <!-- SCRIPT -->
  <script>
      const API_BASE = "http://127.0.0.1:8000/api/pollosabroso";

      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const showRegister = document.getElementById('show-register');
      const showLogin = document.getElementById('show-login');
      const title = document.getElementById('form-title');
      const mensaje = document.getElementById('mensaje');
      const linkUsuario = document.getElementById('linkUsuario');

      // üîê Leer sesi√≥n guardada (si existe)
      const storedToken = localStorage.getItem("token");
      const storedEmail = localStorage.getItem("userEmail");

      // üîó Ajustar comportamiento del icono de usuario seg√∫n sesi√≥n
      if (linkUsuario) {
        if (storedToken) {
          if (storedEmail === "cocinero@gmail.com") {
            linkUsuario.href = "panelControl.html";
          } else if (storedEmail === "repartidor@gmail.com") {
            linkUsuario.href = "panelRepartidor.html";
          } else {
            linkUsuario.href = "sesionUsuario.html";
          }
        } else {
          linkUsuario.href = "registroUsuario.html";
        }
      }

      // üéØ Si ya hay sesi√≥n, no tiene sentido mostrar login/registro ‚Üí redirigimos
      if (storedToken) {
        if (storedEmail === "cocinero@gmail.com") {
          window.location.href = "panelControl.html";
        } else if (storedEmail === "repartidor@gmail.com") {
          window.location.href = "panelRepartidor.html";
        } else {
          window.location.href = "sesionUsuario.html";
        }
      }

      // üîÅ Alternar entre login y registro
      showRegister.addEventListener('click', () => {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        title.textContent = 'Crear Cuenta';
        mensaje.innerHTML = '';
      });

      showLogin.addEventListener('click', () => {
        registerForm.style.display = 'none';
        loginForm.style.display = 'block';
        title.textContent = 'Iniciar Sesi√≥n';
        mensaje.innerHTML = '';
      });

      // üìù REGISTRO REAL contra FastAPI
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById("emailRegister").value.trim();
        const password = document.getElementById("passwordRegister").value.trim();
        const passwordConfirm = document.getElementById("passwordConfirm").value.trim();

        // Validaciones b√°sicas
        if (!email || !password || !passwordConfirm) {
          mensaje.innerHTML = `
            <div class="alert alert-warning">‚ö† Completa todos los campos.</div>`;
          return;
        }

        if (password !== passwordConfirm) {
          mensaje.innerHTML = `
            <div class="alert alert-warning">‚ö† Las contrase√±as no coinciden.</div>`;
          return;
        }

        mensaje.innerHTML = `
          <div class="alert alert-secondary">‚è≥ Creando tu cuenta...</div>`;

        try {
          const payload = {
            name: email.split("@")[0],  // nombre temporal
            email: email,
            phone: "000000000",         // tel√©fono temporal
            password: password
          };

          const res = await fetch(`${API_BASE}/clientes/registro`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          console.log("Respuesta registro:", data);

          if (!res.ok) {
            mensaje.innerHTML = `
              <div class="alert alert-danger">‚ùå ${data.detail}</div>`;
            return;
          }

          mensaje.innerHTML = `
            <div class="alert alert-success">‚úÖ Cuenta creada correctamente.</div>`;

          // Cambiar a formulario de inicio de sesi√≥n
          registerForm.style.display = "none";
          loginForm.style.display = "block";
          title.textContent = "Iniciar Sesi√≥n";

          // Rellenar autom√°ticamente el correo
          document.getElementById("emailLogin").value = email;

        } catch (err) {
          console.error(err);
          mensaje.innerHTML = `
            <div class="alert alert-danger">‚ùå Error de conexi√≥n con el servidor.</div>`;
        }
      });

      // üîê LOGIN REAL contra FastAPI
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById("emailLogin").value.trim();
        const password = document.getElementById("passwordLogin").value.trim();

        if (!email || !password) {
          mensaje.innerHTML = `<div class="alert alert-warning">‚ö† Completa correo y contrase√±a.</div>`;
          return;
        }

        mensaje.innerHTML = `<div class="alert alert-secondary">‚è≥ Iniciando sesi√≥n...</div>`;

        try {
          // OAuth2PasswordRequestForm espera username + password en x-www-form-urlencoded
          const formData = new URLSearchParams();
          formData.append("username", email);
          formData.append("password", password);

          const res = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body: formData
          });

          const data = await res.json();

          if (!res.ok) {
            const msg = data.detail || "Error al iniciar sesi√≥n.";
            mensaje.innerHTML = `<div class="alert alert-danger">‚ùå ${msg}</div>`;
            return;
          }

          // ‚úÖ Guardar token y correo para otras p√°ginas
          localStorage.setItem("token", data.access_token);
          localStorage.setItem("userEmail", email);

          mensaje.innerHTML = `<div class="alert alert-success">‚úÖ Sesi√≥n iniciada correctamente.</div>`;

          // üîÅ Elegir a d√≥nde redirigir seg√∫n el correo
          let redirectUrl = "sesionUsuario.html"; // cliente normal

          if (email === "cocinero@gmail.com") {
            redirectUrl = "panelControl.html";          // panel de cocina
          } else if (email === "repartidor@gmail.com") {
            redirectUrl = "panelRepartidor.html";       // panel repartidor
          }

          // Redirigir despu√©s de un momento
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 800);

        } catch (err) {
          console.error(err);
          mensaje.innerHTML = `<div class="alert alert-danger">‚ùå Error de conexi√≥n con el servidor.</div>`;
        }
      });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
