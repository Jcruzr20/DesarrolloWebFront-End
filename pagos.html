<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pago de Pedido | PolloAsado</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    .metodo-pago {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
    }
  </style>
</head>

<body class="bg-light">

  <!-- NAVBAR -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png" width="50" height="45" class="me-2">
        <h2 class="mb-0">PolloAsado</h2>
      </a>

      <div class="d-flex align-items-center">
        <a href="promociones.html" class="nav-link text-white me-4 fw-semibold">
          <i class="bi bi-megaphone-fill me-1"></i> Promociones
        </a>
        <a href="registroUsuario.html" class="nav-link text-white me-3">
          <i class="bi bi-person-circle" style="font-size:1.5rem;"></i>
        </a>
        <a href="Pedidos.html" class="nav-link text-white position-relative">
          <i class="bi bi-cart3" style="font-size:1.5rem;"></i>
          <span id="contadorCarrito" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="container mt-4">
    <h2 class="text-center mb-4"> Pago de tu Pedido</h2>

    <div class="row">
      <!-- Resumen de pedido -->
      <div class="col-md-7">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white text-center">
            <h5>Resumen del Pedido</h5>
          </div>
          <div class="card-body" id="resumenPedido">
            <p class="text-center text-muted">Cargando tu pedido...</p>
          </div>
          <div class="card-footer text-end">
            <h5>Total: <span id="totalPago">$0</span></h5>
          </div>
        </div>
      </div>

      <!-- Formulario de pago -->
      <div class="col-md-5">
        <div class="card shadow-sm">
          <div class="card-header text-center bg-secondary text-white">
            <h5>Informaci贸n de Pago</h5>
          </div>
          <div class="card-body">
            <form id="formPago">
              <div class="mb-3">
                <label class="form-label">M茅todo de pago</label>
                <select class="form-select" id="metodoPago" required>
                  <option value="Tarjeta"> Tarjeta de cr茅dito / d茅bito</option>
                  <option value="Transferencia"> Transferencia bancaria</option>
                  <option value="MercadoPago"> Billetera Digital (Mercado Pago)</option>
                </select>
              </div>

              <!-- Cup贸n de descuento -->
              <hr class="my-3">
              <div class="mb-3">
                <label for="codigoCupon" class="form-label">Cup贸n de descuento</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="codigoCupon"
                    placeholder="Ingresa tu c贸digo (ej: DESC15-XXXX)"
                  >
                  <button type="button" class="btn btn-outline-primary" id="btnAplicarCupon">
                    Aplicar cup贸n
                  </button>
                </div>
                <div id="mensajeCupon" class="form-text text-muted">
                  Si tienes un cup贸n generado canjeando puntos, ingr茅salo aqu铆.
                </div>
              </div>

              <!-- Campos Tarjeta -->
              <div id="camposTarjeta" class="metodo-pago">
                <div class="mb-3">
                  <label for="numero" class="form-label">N煤mero de Tarjeta</label>
                  <input type="text" class="form-control" id="numero" placeholder="XXXX XXXX XXXX XXXX">
                </div>
                <div class="row">
                  <div class="col-6 mb-3">
                    <label for="vencimiento" class="form-label">Vencimiento</label>
                    <input type="text" class="form-control" id="vencimiento" placeholder="MM/AA">
                  </div>
                  <div class="col-6 mb-3">
                    <label for="cvv" class="form-label">CVV</label>
                    <input type="password" class="form-control" id="cvv" maxlength="3">
                  </div>
                </div>
              </div>

              <!-- Campos Transferencia -->
              <div id="camposTransferencia" class="metodo-pago" style="display:none;">
                <p class="fw-semibold">Datos para transferencia bancaria:</p>
                <ul class="list-unstyled mb-3">
                  <li><strong>Banco:</strong> Banco Estado</li>
                  <li><strong>Cuenta:</strong> 123456789</li>
                  <li><strong>Tipo:</strong> Cuenta Corriente</li>
                  <li><strong>RUT:</strong> 11.111.111-1</li>
                  <li><strong>Nombre:</strong> Pollo Asado Ltda.</li>
                  <li><strong>Correo:</strong> pagos@polloasado.cl</li>
                </ul>
                <p class="text-muted small">锔 Env铆a el comprobante al correo indicado despu茅s de transferir.</p>
              </div>

              <!-- Simulaci贸n Mercado Pago -->
              <div id="camposMercadoPago" class="metodo-pago text-center" style="display:none;">
                <p class="fw-semibold mb-3">Paga f谩cilmente con Mercado Pago</p>
                <img src="https://http2.mlstatic.com/frontend-assets/mp-web-navigation/ui-navigation/5.19.1/mercadopago/logo__large.png" width="160" class="mb-3">
                <p class="text-muted">Ser谩s redirigido a la pasarela segura de Mercado Pago (simulado)</p>
                <button type="button" class="btn btn-primary w-100 mb-3" id="btnSimularMP">
                  <i class="bi bi-wallet2"></i> Ir a Mercado Pago
                </button>
              </div>

              <button type="submit" class="btn btn-success w-100 mt-2">Confirmar Pago</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <br><br><br>

  <!-- FOOTER -->
  <footer class="bg-black text-white mt-5">
    <div class="container py-4">
      <div class="row">
        <div class="col-md-3 mb-3">
          <h4>PolloFast</h4>
          <img src="https://cdn-icons-png.flaticon.com/512/1206/1206237.png" width="50" height="45" class="me-2">
        </div>
        <div class="col-md-3 mb-3">
          <h6>Con贸cenos</h6>
          <p>Tel茅fono</p><p>Mail de contacto</p><p>T茅rminos y condiciones</p>
        </div>
        <div class="col-md-3 mb-3">
          <h6>Redes sociales</h6>
          <p><i class="bi bi-instagram"></i> Instagram</p>
          <p><i class="bi bi-facebook"></i> Facebook</p>
          <p><i class="bi bi-twitter-x"></i> X</p>
        </div>
      </div>
      <div class="text-center mt-3">
        <small><i class="bi bi-circle"></i></small>
      </div>
    </div>
  </footer>

  <!-- SCRIPT -->
  <script>
    const API = "http://127.0.0.1:8000/api/pollosabroso";

    const resumenDiv = document.getElementById("resumenPedido");
    const totalSpan = document.getElementById("totalPago");
    const contador = document.getElementById("contadorCarrito");
    const metodoPago = document.getElementById("metodoPago");

    const camposTarjeta = document.getElementById("camposTarjeta");
    const camposTransferencia = document.getElementById("camposTransferencia");
    const camposMercadoPago = document.getElementById("camposMercadoPago");

    // Cup贸n elementos
    const inputCodigoCupon = document.getElementById("codigoCupon");
    const btnAplicarCupon = document.getElementById("btnAplicarCupon");
    const mensajeCupon = document.getElementById("mensajeCupon");

    // Totales y cup贸n aplicado
    let totalOriginal = 0;
    let totalConDescuento = 0;
    let cuponAplicado = null;
    let descuentoPct = 0;

    metodoPago.addEventListener("change", () => {
      camposTarjeta.style.display = metodoPago.value === "Tarjeta" ? "block" : "none";
      camposTransferencia.style.display = metodoPago.value === "Transferencia" ? "block" : "none";
      camposMercadoPago.style.display = metodoPago.value === "MercadoPago" ? "block" : "none";
    });

    // Simulaci贸n Mercado Pago
    document.getElementById("btnSimularMP")?.addEventListener("click", () => {
      alert(" Simulaci贸n: ser铆as redirigido a Mercado Pago para completar el pago.");
    });

    // Cargar resumen
    function cargarResumen() {
      const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
      resumenDiv.innerHTML = "";
      totalOriginal = 0;

      if (carrito.length === 0) {
        resumenDiv.innerHTML = "<p class='text-center text-muted'>No hay pedidos registrados.</p>";
        totalConDescuento = 0;
        totalSpan.textContent = "$0";
        contador.textContent = "0";
        return;
      }

      contador.textContent = carrito.length;
      carrito.forEach(pedido => {
        let itemsHTML = "";
        pedido.items.forEach(item => {
          const precio = parseInt(item.nombre.match(/\$(\d+)/)?.[1] || 0);
          totalOriginal += precio * item.cantidad;
          itemsHTML += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              ${item.nombre}
              <span class="badge bg-primary">x${item.cantidad}</span>
            </li>`;
        });

        resumenDiv.innerHTML += `
          <div class="card mb-3 shadow-sm">
            <div class="card-header fw-semibold bg-light">${pedido.plato}</div>
            <ul class="list-group list-group-flush">${itemsHTML}</ul>
          </div>`;
      });

      // Al inicio, sin cup贸n, el total con descuento es igual al original
      totalConDescuento = totalOriginal;
      totalSpan.textContent = `$${totalConDescuento.toLocaleString("es-CL")}`;
    }

    // Aplicar cup贸n de descuento
    async function aplicarCupon() {
      const code = inputCodigoCupon.value.trim();
      if (!code) {
        alert("Ingresa un c贸digo de cup贸n.");
        return;
      }

      try {
        const res = await fetch(`${API}/cupones/canjear`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${window.token}`
          },
          body: JSON.stringify({ code })
        });

        const data = await res.json();
        console.log("[pago] respuesta cup贸n:", data);

        if (!res.ok || !data.valid) {
          mensajeCupon.className = "form-text text-danger";
          mensajeCupon.textContent = data.message || "Cup贸n inv谩lido.";
          cuponAplicado = null;
          descuentoPct = 0;
          totalConDescuento = totalOriginal;
          totalSpan.textContent = `$${totalConDescuento.toLocaleString("es-CL")}`;
          return;
        }

        descuentoPct = data.discountPct || 0;
        cuponAplicado = data.code || code;

        const descuento = Math.round(totalOriginal * (descuentoPct / 100));
        totalConDescuento = totalOriginal - descuento;

        mensajeCupon.className = "form-text text-success";
        mensajeCupon.textContent = `${data.message} Nuevo total: $${totalConDescuento.toLocaleString("es-CL")}.`;
        totalSpan.textContent = `$${totalConDescuento.toLocaleString("es-CL")}`;
      } catch (err) {
        console.error("[pago] Error de conexi贸n al validar cup贸n:", err);
        mensajeCupon.className = "form-text text-danger";
        mensajeCupon.textContent = "Error de conexi贸n al validar el cup贸n.";
        cuponAplicado = null;
        descuentoPct = 0;
        totalConDescuento = totalOriginal;
        totalSpan.textContent = `$${totalConDescuento.toLocaleString("es-CL")}`;
      }
    }

    btnAplicarCupon.addEventListener("click", aplicarCupon);

    // Confirmar pago
    document.getElementById("formPago").addEventListener("submit", e => {
      e.preventDefault();

      const metodo = metodoPago.value;
      const carrito = JSON.parse(localStorage.getItem("carrito")) || [];

      // Validar tarjeta
      if (metodo === "Tarjeta") {
        const numero = document.getElementById("numero").value.trim();
        const vencimiento = document.getElementById("vencimiento").value.trim();
        const cvv = document.getElementById("cvv").value.trim();
        if (!numero || !vencimiento || !cvv) {
          alert("锔 Por favor, completa los datos de la tarjeta antes de continuar.");
          return;
        }
      }

      // Guardar datos para confirmaci贸n y boleta
      const infoPago = {
        metodo,
        carrito,
        totalOriginal,
        totalConDescuento,
        cupon: cuponAplicado,
        descuentoPct
      };

      localStorage.setItem("ultimoPago", JSON.stringify(infoPago));
      localStorage.setItem("boletaDatos", JSON.stringify(infoPago));

      // Limpiar carrito
      localStorage.removeItem("carrito");

      // Redirigir
      window.location.href = "confirmacionPago.html";
    });

    cargarResumen();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Protecci贸n de rutas (primero) -->
  <script src="js/protegerRutas.js"></script>
  <script>
    console.log("[pago] Script inline cargado, llamando a requireAuth()");
    window.token = requireAuth();  // dejamos el token disponible como window.token
  </script>
</body>
</html>
